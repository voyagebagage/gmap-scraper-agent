datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider             = "prisma-client-py"
  recursive_type_depth = 5
}

model Place {
  id              Int      @id @default(autoincrement())
  location        String?
  name            String
  rating          Float?
  review_count    Int?
  phone           String?
  address         String
  website         String?
  category        String?
  has_website     Boolean  @default(false)
  sheet_category  String?
  emails          String?
  instagram       String?
  facebook        String?
  whatsapp        String?
  telegram        String?
  messenger       String?
  line            String?
  contact_status  Int?     @default(0)
  updated_at      DateTime @default(now())

  @@unique([name, address])
  @@map("places")
}

model Subscription {
  id               String   @id @default(uuid())
  trial_expires_at DateTime
  is_paid          Boolean  @default(false)
  max_devices      Int      @default(3)
  rate_limit_daily Int      @default(10)
  active_sheet_id  String?  // Currently active sheet for this user
  created_at       DateTime @default(now())
  
  users            AuthorizedUser[]
  usage_logs       UsageLog[]
  payments         Payment[]
  memberships      SheetMembership[]

  @@map("subscriptions")
}

model Sheet {
  id          String   @id @default(uuid())
  name        String?
  gsheet_id   String
  invite_code String   @unique
  created_at  DateTime @default(now())
  
  memberships SheetMembership[]
  payments    Payment[]

  @@map("sheets")
}

model SheetMembership {
  id              String       @id @default(uuid())
  subscription_id String
  subscription    Subscription @relation(fields: [subscription_id], references: [id])
  sheet_id        String
  sheet           Sheet        @relation(fields: [sheet_id], references: [id])
  role            String       @default("manager")  // "manager" or "staff"
  created_at      DateTime     @default(now())
  
  @@unique([subscription_id, sheet_id])
  @@map("sheet_memberships")
}

model AuthorizedUser {
  id              String       @id @default(uuid())
  platform_id     String       // Telegram ID or LINE ID
  platform        String       // "telegram" or "line"
  subscription_id String
  subscription    Subscription @relation(fields: [subscription_id], references: [id])

  @@unique([platform_id, platform])
  @@map("authorized_users")
}

model UsageLog {
  id              Int          @id @default(autoincrement())
  subscription_id String
  subscription    Subscription @relation(fields: [subscription_id], references: [id])
  used_at         DateTime     @default(now())
  platform        String       @default("telegram") // "telegram" or "line"

  @@index([subscription_id, used_at])
  @@map("usage_logs")
}

model Payment {
  id              Int          @id @default(autoincrement())
  subscription_id String
  subscription    Subscription @relation(fields: [subscription_id], references: [id])
  sheet_id        String?
  sheet           Sheet?       @relation(fields: [sheet_id], references: [id])
  amount          Float
  currency        String       @default("THB")
  sender_name     String?
  reference_no    String?
  platform        String       @default("telegram") // "telegram" or "line"
  created_at      DateTime     @default(now())

  @@index([subscription_id, created_at])
  @@map("payments")
}
